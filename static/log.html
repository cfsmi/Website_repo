<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Log Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            color: #d1d5db;
        }

        .log-line {
            font-family: 'Fira Code', monospace;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .log-level-INFO { color: #3b82f6; }
        .log-level-WARN { color: #f59e0b; }
        .log-level-ERROR { color: #ef4444; }
        .log-level-DEBUG { color: #8b5cf6; }
        .log-level-DEFAULT { color: #6b7280; }

        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937;
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }

        .status-dot-connecting { background-color: #f59e0b; }
        .status-dot-live { background-color: #22c55e; }
        .status-dot-paused { background-color: #6b7280; animation: none; }
        .status-dot-error { background-color: #ef4444; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col p-4 sm:p-6 lg:p-8">

    <div class="flex-shrink-0">
        <!-- Header Section -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <div class="flex flex-wrap items-center gap-4">
                 <h1 class="text-2xl font-bold text-white">API Log Viewer</h1>
                 <div id="status-indicator" class="flex items-center gap-2 px-3 py-1 bg-gray-900/50 rounded-full text-sm">
                     <span id="status-dot" class="status-dot status-dot-connecting"></span>
                     <span id="status-text">Connecting...</span>
                 </div>
                 <!-- NEW: Visit Counter Display -->
                 <div id="visit-counter-display" class="flex items-center gap-2 px-3 py-1 bg-gray-900/50 rounded-full text-sm text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                        <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/>
                        <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/>
                    </svg>
                    <span>Total Visits: <span id="visit-count" class="font-semibold text-gray-200">--</span></span>
                 </div>
            </div>
            
            <div class="flex items-center gap-2 flex-shrink-0">
                <button id="refresh-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-md transition-colors duration-200">Refresh</button>
                <button id="clear-btn" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white font-medium rounded-md transition-colors duration-200">Clear</button>
                <div class="flex items-center space-x-2 pl-4">
                    <span class="text-sm font-medium">Auto-Refresh</span>
                    <label for="auto-refresh-toggle" class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="auto-refresh-toggle" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-800 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
            </div>
        </header>
    </div>

    <!-- Log Display Area -->
    <main id="log-container" class="flex-grow bg-gray-900 rounded-lg p-4 overflow-y-auto text-sm">
        <!-- Logs will be inserted here -->
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const logContainer = document.getElementById('log-container');
            const refreshBtn = document.getElementById('refresh-btn');
            const clearBtn = document.getElementById('clear-btn');
            const autoRefreshToggle = document.getElementById('auto-refresh-toggle');
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            const visitCountSpan = document.getElementById('visit-count');

            let autoRefreshInterval = null;

            const updateStatus = (status, text) => {
                statusDot.className = `status-dot status-dot-${status}`;
                statusText.textContent = text;
            };

            const getLogLevelClass = (level) => {
                const upperLevel = level.toUpperCase();
                switch(upperLevel) {
                    case 'INFO': return 'log-level-INFO';
                    case 'WARN': return 'log-level-WARN';
                    case 'ERROR': return 'log-level-ERROR';
                    case 'DEBUG': return 'log-level-DEBUG';
                    default: return 'log-level-DEFAULT';
                }
            };

            const fetchLogs = async () => {
                try {
                    const response = await fetch('/api/logs');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const logs = await response.json();
                    
                    logContainer.innerHTML = ''; // Clear previous logs
                    if (logs.length === 0) {
                        logContainer.innerHTML = '<p class="text-gray-500">No logs to display.</p>';
                    } else {
                        logs.reverse().forEach(log => { // Show newest logs first
                            const logElement = document.createElement('div');
                            logElement.className = 'log-line flex flex-col md:flex-row md:items-baseline gap-x-4 py-1 border-b border-gray-800';
                            
                            const timestamp = log.timestamp ? log.timestamp.split(',')[0] : 'No Timestamp';
                            const levelClass = log.level ? getLogLevelClass(log.level) : 'log-level-DEFAULT';
                            const level = log.level || 'LOG';

                            logElement.innerHTML = `
                                <span class="text-gray-500 flex-shrink-0">${timestamp}</span>
                                <span class="${levelClass} font-bold w-16 flex-shrink-0">[${level}]</span>
                                <span class="text-gray-300 flex-grow">${log.message || 'No message content.'}</span>
                            `;
                            logContainer.appendChild(logElement);
                        });
                    }
                } catch (error) {
                    console.error('Failed to fetch logs:', error);
                    updateStatus('error', 'Error');
                    logContainer.innerHTML = `<p class="text-red-500">Failed to load logs. Is the backend running? Error: ${error.message}</p>`;
                }
            };

            const fetchVisitCount = async () => {
                try {
                    const response = await fetch('/api/visits');
                    if (!response.ok) throw new Error('Failed to fetch visits');
                    const data = await response.json();
                    visitCountSpan.textContent = data.visits.toLocaleString() || '0';
                } catch (error) {
                    console.error('Failed to fetch visit count:', error);
                    visitCountSpan.textContent = 'N/A';
                }
            };

            const toggleAutoRefresh = () => {
                if (autoRefreshToggle.checked && !autoRefreshInterval) {
                    autoRefreshInterval = setInterval(() => {
                        fetchLogs();
                        fetchVisitCount();
                    }, 3000);
                    updateStatus('live', 'Live');
                } else if (!autoRefreshToggle.checked && autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                    updateStatus('paused', 'Paused');
                }
            };

            refreshBtn.addEventListener('click', () => {
                fetchLogs();
                fetchVisitCount();
            });
            clearBtn.addEventListener('click', () => {
                logContainer.innerHTML = '<p class="text-gray-500">Logs cleared.</p>';
            });
            autoRefreshToggle.addEventListener('change', toggleAutoRefresh);

            // Initial fetch and start auto-refresh
            fetchLogs();
            fetchVisitCount();
            toggleAutoRefresh();
        });
    </script>

</body>
</html>

